# Development Environment
>
> **Notice:**
> gcloud auth is configured to log you out every 24h. You must re-login every 24h
>
> ```sh
> gcloud auth login --update-adc
> ```

<!-- TOC -->

- [Development Environment](#development-environment)
  - [Running the Control Plane](#running-the-control-plane)
    - [Accessing the UI in the browser](#accessing-the-ui-in-the-browser)
  - [Building the UI locally](#building-the-ui-locally)
    - [Submitting a change for your UI](#submitting-a-change-for-your-ui)

<!-- /TOC -->
## Running the Control Plane

We currently only support running control plane in GKE (support for Minikube coming soon). To get a development version of the control plane up-and-running:

1. Add the dev cluster to your Kubeconfig:

    ```sh
    gcloud container clusters get-credentials dev-cluster --zone us-west1-a --project gimlet-dev-0
    ```

1. Set the default repo for skaffold. This specifies the registry it should push images to.

    ```sh
    skaffold config set default-repo us-docker.pkg.dev/gimlet-dev-0/gimlet-dev-docker-artifacts
    ```

1. Add `export SKAFFOLD_LABEL=skaffold.dev/run-id=PREVENT_REDEPLOY` to your .bashrc or .zshrc.

1. Configure docker to use gcloud for auth:

    ```sh
    gcloud auth configure-docker us-docker.pkg.dev
    ```

1. Run skaffold to deploy any dependencies to your namespace. You should only need to run this once unless you are configuring the dependencies. Unfortunately, the `helm depo update` is required due to [#8036](https://github.com/helm/helm/issues/8036), [#9903](https://github.com/helm/helm/issues/9903).

    ```sh
    helm dep update k8s/charts/controlplane_deps/
    skaffold run -f skaffold/skaffold_controlplane_deps.yaml -n <YOUR_USERNAME> -p dev
    ```

1. Run skaffold to build and deploy the services in your namespace:

    ```sh
    skaffold run -f skaffold/skaffold_controlplane.yaml -n <YOUR_USERNAME> -p dev
    ```

### Accessing the UI in the browser

We have ingress and LetsEncrypt signed certs automatically setup for the dev cluster. As long as you are on
tailscale, you should be able to just navigate to `<YOUR_USERNAME>.dev.app.gimletlabs.dev` via your browser
to access the UI.

## Building the UI locally

1. Make sure you have envoy installed locally. Chef manages this on linux machines. If you are running macOS, you can use Homebrew.

    ```sh
    brew install envoy
    ```

1. Make sure you have certs for your machine. These are generated by tailscale. Our `run_proxy.sh` script expects these certs to be in your homedir, but you can override the location if needed by setting the SSL_CRT_PATH and SSL_KEY_PATH env vars.

    ```sh
    sudo tailscale cert ${HOSTNAME}.beluga-snapper.ts.net
    ```

1. Make the tailscale cert key readable by `sudo` (on Linux) or `admin` (on MacOS).

    ```sh
    sudo chgrp <ADMIN_GROUP> ${HOSTNAME}.beluga-snapper.ts.net.key
    sudo chmod g+r ${HOSTNAME}.beluga-snapper.ts.net.key
    ```

1. Set the env vars:

    ```sh
    export AUTH0_CLIENT_ID='f66GcpkIKEliCvvPoejx3Y6mlmYiM8p6'
    export AUTH0_ISSUER_BASE_URL='gimlet-dev.us.auth0.com'
    ```

1. To point to a backend that isn't yours, set the `BACKEND` env var. We default to `${USER}.dev.app.gimletlabs.dev`

1. From the `src/ui` directory, run `pnpm dev`.

    ```sh
    pnpm dev
    ```

1. Access the dev UI at the envoy port with your host's FQDN. Since the envoy port is dynamically assigned, check the output from `pnpm dev` for your UI location. For eg `https://${HOSTNAME}.beluga-snapper.ts.net:8989`

### Submitting a change for your UI

As of Oct. 6, 2023, you'll need to do the following whenever you add a new file to the UI, otherwise the bazel build will not find it.
If you don't do this, pnpm dev will still pull the page, but bazel/skaffold will not be able to build the image.

```sh
# Create your new file in the UI
cd src/ui/path/to
touch newfile.tsx # placeholder for making a new file

# At the top of the git tree
make gazelle # this will generate a new BUILD.bazel file for your new file
make lint # this will run the linter and fail if you have any errors

# Now update the `next_srcs` array to include the generated target for your new file
vim src/ui/BUILD.bazel # add //src/ui/path/to:newfile to the next_srcs array
```

And from there you can git commit and push your changes.

### Accessing the development postgres DB

You can access the development postgres DB via your namespace like so: After [running the control plane setup](#running-the-control-plane), you should have a pod called `db-reader-writer-<id>` pod in your `<YOUR_USERNAME>` namespace.
SSH into that pod ( _ie with k9s_) and run the following command to access the DB:

```sh
# password is gml
psql -U gml -h localhost  -d <YOUR_USERNAME>
```


Then you can run queries like so:

```sql
SELECT * from fleets;
```

You should use transactions if you want to make changes to the DB:

```sql
BEGIN;
INSERT INTO fleets (name, org_id, created_at, updated_at) VALUES ('test', '09b4690d-5e92-437b-9401-41ee8edb3bdb', now(), now());

-- If you want to rollback your changes, run:
-- ROLLBACK;
COMMIT;
```
